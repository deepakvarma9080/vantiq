<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cart | VANTIQ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;color:#000}
header{background:#000;color:#fff;padding:14px;text-align:center;font-size:20px;}
.cart-container{max-width:1000px;margin:20px auto;padding:20px;background:#fff;border-radius:12px;}
.cart-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #ddd;}
.cart-item img{width:100px;height:100px;object-fit:cover;border-radius:8px;}
.item-info{flex:1;}
.item-info h4{margin:0 0 6px;font-size:16px;}
.item-info p{margin:2px 0;font-size:14px;color:#555;}
.quantity-control{display:flex;align-items:center;gap:8px;}
.quantity-control button{padding:4px 10px;cursor:pointer;}
.total-section{margin-top:20px;text-align:right;font-size:18px;font-weight:bold;}
.checkout-btn{padding:12px 20px;background:#ff2e2e;color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer;margin-top:10px;}
</style>
</head>
<body>

<header>ðŸ›’ My Cart</header>

<div class="cart-container" id="cartContainer">
  Loading cart...
</div>

<script>
const API_BASE = "https://vantiq-723z.onrender.com";

const token = localStorage.getItem("token");
if(!token){
  alert("Please login first");
  location.href = "login.html";
}

async function loadCart(){
  const res = await fetch(`${API_BASE}/api/cart`,{
    headers:{Authorization:"Bearer "+token}
  });
  const cart = await res.json();

  const container = document.getElementById("cartContainer");
  container.innerHTML = "";

  if(!cart.items || cart.items.length===0){
    container.innerHTML = "<p>Your cart is empty!</p>";
    return;
  }

  let total = 0;

  for(const item of cart.items){
    // fetch product details
    const prodRes = await fetch(`${API_BASE}/api/product/${item.productId}`);
    const p = await prodRes.json();

    total += p.price * item.quantity;

    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `
      <img src="${API_BASE}/uploads/${p.images[0]}" alt="${p.name}">
      <div class="item-info">
        <h4>${p.name}</h4>
        <p>â‚¹${p.price} Ã— ${item.quantity}</p>
        <div class="quantity-control">
          <button onclick="changeQty('${item._id}', -1)">-</button>
          <span>${item.quantity}</span>
          <button onclick="changeQty('${item._id}', 1)">+</button>
          <button onclick="removeItem('${item._id}')">Remove</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  }

  const totalDiv = document.createElement("div");
  totalDiv.className = "total-section";
  totalDiv.innerHTML = `Total: â‚¹${total} <br><button class="checkout-btn" onclick="checkout(${total})">Place Order</button>`;

  container.appendChild(totalDiv);
}

async function changeQty(itemId, delta){
  await fetch(`${API_BASE}/api/cart/update`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body:JSON.stringify({ itemId, delta })
  });
  loadCart();
}

async function removeItem(itemId){
  await fetch(`${API_BASE}/api/cart/remove`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body:JSON.stringify({ itemId })
  });
  loadCart();
}

// ================== RAZORPAY CHECKOUT ==================
async function checkout(amount){
  // fetch full backend cart
  const res = await fetch(`${API_BASE}/api/cart`, {
    headers: { Authorization: "Bearer " + token }
  });
  const cartData = await res.json();

  // Build items array with name, price, quantity
  const items = [];

  for(const item of cartData.items){
    const prodRes = await fetch(`${API_BASE}/api/product/${item.productId}`);
    const p = await prodRes.json();

    items.push({
      productId: item.productId,
      name: p.name,
      price: p.price,
      quantity: item.quantity
    });
  }

  // Save to localStorage
  localStorage.setItem("cartSubtotal", amount);
  localStorage.setItem("cartItems", JSON.stringify(items));

  // Go to checkout
  window.location.href = "checkout.html";
}




loadCart();
</script>
</body>
</html>


